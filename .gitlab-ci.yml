stages:
  - build
  - test

build-job:
  image: rust:latest
  stage: build
  variables:
    APP_ENV: production
  script:
    - cargo build --release
  artifacts:
    paths:
      - target/

test-job:
  image: rust:latest
  stage: test
  services:
    - name: postgres
      alias: db
  variables:
    POSTGRES_USER: postres
    POSTGRES_PASSWORD: password
    POSTGRES_DB: newsletter
    PORTGRES_PORT: 5432
    POSTGRES_HOST_AUTH_METHOD: trust
    APP_ENV: development

  script:
    - sleep 5 # wait for postgres
    - cargo check
    - cargo test
  dependencies:
    - build-job

